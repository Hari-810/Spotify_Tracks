import os
from pyspark.sql import SparkSession
from PyPDF2 import PdfReader

def check_file_exists(file_path):
    """Check if a file exists in an ADLS-mounted directory."""
    try:
        dir_path = file_path.rsplit('/', 1)[0]
        file_name = file_path.split('/')[-1]
        files = dbutils.fs.ls(dir_path)
        
        for file in files:
            if file.name == file_name:
                print(f"File exists: {file_path}")
                return True
        
        print(f"File NOT found: {file_path}")
        return False
    except Exception as e:
        print(f"Error checking file existence: {e}")
        return False

def read_text_file(file_path):
    """Read content from a text file in ADLS using normal Python open function."""
    try:
        temp_path = file_path.replace("/mnt/", "/dbfs/mnt/")  # Adjust path for DBFS compatibility
        with open(temp_path, "r", encoding="utf-8") as file:
            content = file.read()
        print(content)
    except Exception as e:
        print(f"Error reading text file: {e}")

def copy_file_to_dbfs(src_path, dest_path):
    """Copy file from ADLS-mounted storage to DBFS."""
    try:
        dbutils.fs.cp(src_path, dest_path)
        print(f"File copied to {dest_path}")
        return True
    except Exception as e:
        print(f"Error copying file to DBFS: {e}")
        return False

def read_pdf_file(pdf_dbfs_path):
    """Read and extract text from a PDF file stored in DBFS."""
    try:
        local_pdf_path = pdf_dbfs_path.replace("dbfs:/", "/dbfs/")
        with open(local_pdf_path, "rb") as file:
            pdf = PdfReader(file)
            text = "\n".join([page.extract_text() for page in pdf.pages if page.extract_text()])
        print(text)
    except Exception as e:
        print(f"Error reading PDF file: {e}")

if __name__ == "__main__":
    # Define file path
    file_path = "/mnt/npdaimladlsuse2/dev2/US-000-1/APIPlatform/.../Uploads/file"
    
    if check_file_exists(file_path):
        if file_path.lower().endswith(".txt"):
            read_text_file(file_path)
        elif file_path.lower().endswith(".pdf"):
            dbfs_pdf_path = "dbfs:/tmp/file.pdf"
            if copy_file_to_dbfs(file_path, dbfs_pdf_path):
                read_pdf_file(dbfs_pdf_path)
